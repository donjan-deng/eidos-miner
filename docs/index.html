<!doctype html>
<html lang="zh-cn">

<head>
    <title>eidos空投矿机</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/eosjs@16.0.0/lib/eos.min.js"></script>
    <script src="scatter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script>
        const config = {
            interval_second: 5,//挖一次间隔(秒),各位持币大佬别把间隔改太小了，给节点造成压力。
            refresh_account_second: 5,//刷新用户信息间隔（秒）
            cpu_wait_min: 5,//CPU耗尽等待时间（分钟）
            log_max: 20,//保留多少行日志
            nodes: [ //可用节点
                {
                    protocol: 'https',
                    host: 'nodes.get-scatter.com',
                    port: 443
                },
                {
                    protocol: 'https',
                    host: 'eos.newdex.one',
                    port: 443
                }, {
                    protocol: 'https',
                    host: 'api.eosdetroit.io',
                    port: 443
                }, {
                    protocol: 'https',
                    host: 'api.main.alohaeos.com',
                    port: 443
                }
            ]
        }
        const data = {
            scatter_account: null,
            account: null,
            eidos: 0,
            log: []
        }
        let network = config.nodes[Math.floor((Math.random() * config.nodes.length))];
        network.blockchain = 'eos';
        network.chainId = 'aca376f206b8fc25a6ed44dbdc66547c36c6c33e3a119ffbeaef943642f0e906';
        let eos;
        scatter.connect("eidos-miner").then(function (connected) {
            console.log('connected', connected)
            if (connected) {
                eos = scatter.eos(network, Eos);
                console.log('id before', scatter.identity)
                scatter.getIdentity({ accounts: [network] }).then(function (id) {
                    data.scatter_account = id.accounts.find(function (x) { return x.blockchain === 'eos' });
                    mining();
                    getAccount();
                }).catch(function (e) {
                    console.log(e);
                });
            }
        }).catch(function (x) {
            console.log('x', x);
        });
        function mining() {
            const transactionOptions = { authorization: [`${data.scatter_account.name}@${data.scatter_account.authority}`] };
            eos.transfer(data.scatter_account.name, 'eidosonecoin', '0.0001 EOS', 'memo', transactionOptions).then(trx => {
                addLog(moment().format('YYYY-MM-DD HH:mm') + ` 挖矿成功!,Transaction ID: ${trx.transaction_id}`);
                setTimeout(mining, config.interval_second * 1000);
            }).catch(error => {
                error = JSON.parse(error);
                if (error.error && error.error.code == 3080004) {
                    addLog(moment().format('YYYY-MM-DD HH:mm') + ' CPU已用完，' + config.cpu_wait_min + '分钟后继续...');
                    setTimeout(mining, config.cpu_wait_min * 60 * 1000);
                } else {
                    addLog(error);
                    setTimeout(mining, config.interval_second * 1000);
                }
            });
        }
        function getAccount() {
            eos.getAccount(data.scatter_account.name).then(result => {
                data.account = result;
                getEidos();
            }).catch(error => {
                setTimeout(getAccount, config.refresh_account_second * 1000);
            });
        }
        function getEidos() {
            eos.getCurrencyBalance('eidosonecoin', data.scatter_account.name, 'EIDOS').then(result => {
                data.eidos = result[0];
                output();
                setTimeout(getAccount, config.refresh_account_second * 1000);
            }).catch(error => {
                setTimeout(getAccount, config.refresh_account_second * 1000);
            });
        }
        function output() {
            if (data.account) {
                $('#log').empty();
                $('#log').append("<p>帐户:" + data.scatter_account.name + "</p>");
                $('#log').append("<p>EIDOS:" + data.eidos + "</p>");
                $('#log').append("<p>EIDOS:" + data.account.cpu_limit.used + '/' + data.account.cpu_limit.max + "</p>");
                $('#log').append("<p>  </p>");
                data.log.forEach(e => {
                    $('#log').append("<p>EIDOS:" + e + "</p>");
                });
            }
        }
        function addLog(str) {
            data.log.push(str);
            if (data.log.length > config.log_max) {
                data.log = data.log.slice(0, config.log_max);
            }
        }
    </script>
</head>

<body>
    <h1>eidos空投矿机</h1>
    <h2>运行日志</h2>
    <div id='log'>

    </div>
</body>

</html>